<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Complete School System</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{font-family:Times New Roman;margin:0;background:#eef2f7}
header{background:#0b3d91;color:white;text-align:center;padding:15px;font-size:26px}
.container{padding:20px;max-width:1200px;margin:auto}
.card{background:white;padding:18px;margin-bottom:18px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
input,select,textarea{padding:8px;margin:5px;border:1px solid #aaa;width:auto}
button{padding:8px 14px;background:#0b3d91;color:white;border:none;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid black;padding:6px;text-align:center}
th{background:#2f5597;color:white}
.hidden{display:none}
.reportCard{width:800px;margin:auto;border:4px double #1e90ff;padding:20px;background:white}
.title{color:#1e90ff;text-align:center;font-weight:bold;font-size:22px;text-decoration:underline}
.totalRow{background:#f4d35e;font-weight:bold}
.small{font-size:13px}
</style>
</head>
<body>
<header>School Management System</header>
<div class="container">

<!-- LOGIN -->
<div class="card" id="loginBox">
<h3>Login</h3>
<select id="role"><option value="admin">Admin</option><option value="teacher">Teacher</option></select>
<input id="user" placeholder="Username">
<input id="pass" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<p>Admin: admin/1234 | Teacher: teacher/1234</p>
</div>

<!-- SYSTEM -->
<div id="system" class="hidden">
<div class="card"><button onclick="location.reload()">Logout</button></div>

<!-- ADMIN SETTINGS -->
<div class="card admin">
<h3>School Settings</h3>
<input id="schoolName" placeholder="School Name">
<input id="term" placeholder="Term">
<input id="year" placeholder="Year">
<input type="file" id="logo" accept="image/*">
</div>

<!-- ADD STUDENT -->
<div class="card admin">
<h3>Add Student</h3>
<input id="name" placeholder="Name">
<input id="adm" placeholder="Adm No">
<select id="grade">
<option>Lower Primary</option>
<option>Upper Primary</option>
<option>Junior School</option>
</select>
<button onclick="addStudent()">Add</button>
</div>

<!-- MARK ENTRY -->
<div class="card teacher">
<h3>Enter Marks</h3>
<input id="admMark" placeholder="Adm No">
<select id="subject"></select>
<input id="score" type="number" placeholder="Score">
<button onclick="saveMark()">Save</button>
</div>

<!-- TABLE -->
<div class="card">
<h3>Students</h3>
<table id="table"></table>
</div>

<!-- ANALYTICS -->
<div class="card">
<h3>Performance Analytics</h3>
<canvas id="chartCanvas"></canvas>
</div>

<!-- REPORT -->
<div class="card">
<h3>Generate Report</h3>
<input id="searchAdm" placeholder="Adm No">
<textarea id="tRemark" placeholder="Class Teacher Remarks"></textarea>
<textarea id="hRemark" placeholder="Head Teacher Remarks"></textarea>
<button onclick="generateReport()">Generate</button>
<button onclick="print()">Print PDF</button>
<div id="report"></div>
</div>

</div>
</div>

<script>
let students=JSON.parse(localStorage.getItem("students")||"[]");
let marks=JSON.parse(localStorage.getItem("marks")||"{}");
let roleUser=null;

const subjectsByGrade={
"Lower Primary":["English","Mathematics","Kiswahili","Environmental","CRE","Creative"],
"Upper Primary":["English","Mathematics","Kiswahili","Science","Agriculture","Social","CRE","Creative"],
"Junior School":["English","Mathematics","Kiswahili","Integrated Science","Agriculture","Social Studies","CRE","Pre-Technical","Creative"]
};

function save(){localStorage.setItem("students",JSON.stringify(students));localStorage.setItem("marks",JSON.stringify(marks));render();chart();}

function login(){
if(user.value=="admin"&&pass.value=="1234")roleUser="admin";
else if(user.value=="teacher"&&pass.value=="1234")roleUser="teacher";
else return alert("Wrong login");
loginBox.classList.add("hidden");system.classList.remove("hidden");
document.querySelectorAll(".admin").forEach(x=>x.style.display=roleUser=="admin"?"block":"none");
document.querySelectorAll(".teacher").forEach(x=>x.style.display=roleUser=="teacher"?"block":"none");
updateSubjects();render();chart();
}

function updateSubjects(){
let g=students[0]?.grade||"Lower Primary";
subject.innerHTML="";
subjectsByGrade[g].forEach(s=>subject.innerHTML+=`<option>${s}</option>`);
}

function addStudent(){students.push({name:name.value,adm:adm.value,grade:grade.value});save();updateSubjects()}

function saveMark(){if(!marks[admMark.value])marks[admMark.value]=[];marks[admMark.value].push({sub:subject.value,score:Number(score.value)});save()}

function avg(adm){let m=marks[adm];if(!m)return 0;return(m.reduce((a,b)=>a+b.score,0)/m.length).toFixed(1)}

function rank(){let arr=students.map(s=>({adm:s.adm,av:Number(avg(s.adm))}));arr.sort((a,b)=>b.av-a.av);let r={};arr.forEach((x,i)=>r[x.adm]=i+1);return r}

function render(){let r=rank();table.innerHTML="<tr><th>Name</th><th>Adm</th><th>Grade</th><th>Avg</th><th>Position</th></tr>";students.forEach(s=>table.innerHTML+=`<tr><td>${s.name}</td><td>${s.adm}</td><td>${s.grade}</td><td>${avg(s.adm)}</td><td>${r[s.adm]}</td></tr>`)}

function chart(){
new Chart(chartCanvas,{type:"bar",data:{labels:students.map(s=>s.name),datasets:[{data:students.map(s=>avg(s.adm))}]}});
}

function gradeScale(m){
m=Number(m);
if(m>=90)return["EE1",8];
if(m>=75)return["EE2",7];
if(m>=58)return["ME1",6];
if(m>=41)return["ME2",5];
if(m>=31)return["AE1",4];
if(m>=21)return["AE2",3];
if(m>=11)return["BE1",2];
return["BE2",1];
}

function generateReport(){
let s=students.find(x=>x.adm==searchAdm.value); if(!s)return alert("Not found");
let m=marks[s.adm]||[];
let rows="";
m.forEach(x=>{let g=gradeScale(x.score);rows+=`<tr><td>${x.sub}</td><td>${x.score}</td><td>${g[1]}</td><td>${g[0]}</td></tr>`});
let average=avg(s.adm);
let perf=gradeScale(average);
let pos=rank()[s.adm];

let logoURL="";
let file=document.getElementById("logo").files[0];
if(file)logoURL=URL.createObjectURL(file);

report.innerHTML=`<div class='reportCard'>
<div style='text-align:center'>
${logoURL?`<img src='${logoURL}' height='80'><br>`:""}
<h2>${schoolName.value||"SCHOOL NAME"}</h2>
<div class='title'>${s.grade.toUpperCase()} ASSESSMENT SHEET</div>
<b>TERM:</b> ${term.value||""} &nbsp;&nbsp; <b>YEAR:</b> ${year.value||""}
</div>
<br>
<b>NAME:</b> ${s.name} &nbsp;&nbsp; <b>ADM:</b> ${s.adm}<br>
<b>POSITION:</b> ${pos}<br><br>
<table>
<tr><th>LEARNING AREAS</th><th>MARKS (%)</th><th>POINTS</th><th>P.L</th></tr>
${rows}
<tr class='totalRow'><td>TOTAL</td><td>${average}</td><td>${perf[1]}</td><td>${perf[0]}</td></tr>
</table>
<br>
<b>Class Teacher Remarks:</b><br>${tRemark.value}<br><br>
<b>Head Teacher Remarks:</b><br>${hRemark.value}<br><br>
<div class='small'>
<b>KEY</b><br>
EE1=Exceeding 1 | EE2=Exceeding 2 | ME1=Meeting 1 | ME2=Meeting 2 | AE1=Approaching 1 | AE2=Approaching 2 | BE1=Below 1 | BE2=Below 2
</div>
</div>`
}

render();
</script>
</body>
</html>
